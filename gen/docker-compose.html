<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Docker Compose IDE</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Consolas', 'Monaco', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      background: #252526;
      padding: 12px 20px;
      border-bottom: 1px solid #3e3e42;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 1.3em;
      color: #4ec9b0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      background: #0e639c;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      background: #1177bb;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-success {
      background: #388a34;
    }

    .btn-success:hover {
      background: #4ba33f;
    }

    .btn-secondary {
      background: #3e3e42;
    }

    .btn-secondary:hover {
      background: #505050;
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .editor-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #3e3e42;
      background: #1e1e1e;
    }

    .editor-header {
      background: #252526;
      padding: 8px 16px;
      border-bottom: 1px solid #3e3e42;
      font-size: 0.9em;
      color: #858585;
    }

    .editor-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .yaml-line {
      display: flex;
      align-items: flex-start;
      min-height: 28px;
      position: relative;
      padding: 2px 0;
      transition: background 0.1s;
    }

    .yaml-line:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .yaml-line.error {
      background: rgba(244, 67, 54, 0.1);
      border-left: 3px solid #f44336;
      padding-left: 4px;
    }

    .line-number {
      min-width: 50px;
      text-align: right;
      color: #858585;
      font-size: 0.9em;
      user-select: none;
      padding-right: 20px;
    }

    .line-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .collapse-btn {
      color: #858585;
      cursor: pointer;
      font-size: 1em;
      width: 20px;
      text-align: center;
      user-select: none;
      transition: color 0.2s;
    }

    .collapse-btn:hover {
      color: #d4d4d4;
    }

    .key {
      color: #9cdcfe;
      cursor: pointer;
      font-weight: 500;
    }

    .key:hover {
      text-decoration: underline;
    }

    .colon {
      color: #d4d4d4;
      margin: 0 4px;
    }

    .value-input {
      background: #3c3c3c;
      border: 1px solid #555;
      color: #ce9178;
      padding: 4px 8px;
      border-radius: 3px;
      font-family: inherit;
      font-size: 0.95em;
      min-width: 200px;
      transition: all 0.2s;
    }

    .value-input:focus {
      outline: none;
      border-color: #0e639c;
      background: #2d2d30;
      box-shadow: 0 0 0 2px rgba(14, 99, 156, 0.2);
    }

    .array-dash {
      color: #d4d4d4;
      margin-right: 6px;
    }

    .add-btn, .delete-btn {
      opacity: 0;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 1.1em;
      transition: all 0.2s;
      user-select: none;
    }

    .yaml-line:hover .add-btn,
    .yaml-line:hover .delete-btn {
      opacity: 1;
    }

    .add-btn {
      color: #4ec9b0;
      background: rgba(78, 201, 176, 0.1);
    }

    .add-btn:hover {
      background: rgba(78, 201, 176, 0.2);
      color: #6ee7c7;
    }

    .delete-btn {
      color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }

    .delete-btn:hover {
      background: rgba(244, 67, 54, 0.2);
      color: #ff5252;
    }

    .autocomplete-popup {
      position: fixed;
      background: #252526;
      border: 1px solid #3e3e42;
      border-radius: 6px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
      z-index: 1000;
      max-height: 350px;
      overflow-y: auto;
      min-width: 300px;
    }

    .autocomplete-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #3e3e42;
      transition: background 0.1s;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover {
      background: #2a2d2e;
    }

    .autocomplete-item.selected {
      background: #0e639c;
    }

    .autocomplete-key {
      color: #9cdcfe;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .autocomplete-desc {
      color: #858585;
      font-size: 0.85em;
    }

    .autocomplete-type {
      color: #4ec9b0;
      font-size: 0.8em;
      margin-top: 4px;
    }

    .right-panel {
      width: 380px;
      background: #252526;
      display: flex;
      flex-direction: column;
    }

    .panel-tabs {
      display: flex;
      background: #2d2d30;
      border-bottom: 1px solid #3e3e42;
    }

    .panel-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      color: #858585;
      font-size: 0.9em;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .panel-tab:hover {
      color: #d4d4d4;
    }

    .panel-tab.active {
      color: #d4d4d4;
      border-bottom-color: #0e639c;
      background: #252526;
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .issue-item {
      background: rgba(244, 67, 54, 0.1);
      border-left: 4px solid #f44336;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 4px;
      animation: slideIn 0.3s;
    }

    .issue-item.warning {
      background: rgba(255, 193, 7, 0.1);
      border-left-color: #ffc107;
    }

    .issue-title {
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      font-size: 0.85em;
    }

    .issue-message {
      font-size: 0.9em;
      color: #d4d4d4;
      line-height: 1.5;
    }

    .issue-line {
      font-size: 0.8em;
      color: #858585;
      margin-top: 6px;
    }

    .suggestion-item {
      background: rgba(78, 201, 176, 0.1);
      border-left: 4px solid #4ec9b0;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      animation: slideIn 0.3s;
    }

    .suggestion-item:hover {
      background: rgba(78, 201, 176, 0.2);
      transform: translateX(4px);
    }

    .suggestion-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: #4ec9b0;
    }

    .suggestion-desc {
      font-size: 0.9em;
      color: #d4d4d4;
      line-height: 1.5;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #858585;
      gap: 16px;
      text-align: center;
    }

    .empty-state-icon {
      font-size: 4em;
      opacity: 0.4;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #858585;
      gap: 16px;
    }

    .spinner {
      border: 3px solid #3e3e42;
      border-top: 3px solid #0e639c;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    ::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    ::-webkit-scrollbar-thumb {
      background: #424242;
      border-radius: 6px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #4e4e4e;
    }

    .collapsed {
      display: none !important;
    }

    .docs-section {
      margin-bottom: 20px;
    }

    .docs-title {
      color: #4ec9b0;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 1.1em;
    }

    .docs-content {
      color: #d4d4d4;
      line-height: 1.8;
      font-size: 0.9em;
    }

    .docs-content li {
      margin-bottom: 8px;
      padding-left: 8px;
    }

    .code-example {
      background: #1e1e1e;
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 0.85em;
      color: #ce9178;
      border: 1px solid #3e3e42;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>
      <span>üì¶</span>
      Docker Compose IDE
    </h1>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="loadTemplates()">
        <span>üìã</span> Templates
      </button>
      <button class="btn btn-success" id="validateBtn" onclick="validateWithAI()">
        <span>‚úì</span> Validate
      </button>
      <button class="btn" id="suggestBtn" onclick="getSuggestions()">
        <span>üí°</span> AI Suggestions
      </button>
      <button class="btn btn-secondary" onclick="exportYAML()">
        <span>‚¨á</span> Export
      </button>
    </div>
  </div>

  <div class="main-content">
    <div class="editor-panel">
      <div class="editor-header">
        üìÑ docker-compose.yml
      </div>
      <div class="editor-content" id="editorContent">
        <!-- Lines will be rendered here -->
      </div>
    </div>

    <div class="right-panel">
      <div class="panel-tabs">
        <div class="panel-tab active" data-panel="validation" onclick="switchPanel('validation')">
          Validation
        </div>
        <div class="panel-tab" data-panel="suggestions" onclick="switchPanel('suggestions')">
          AI Suggestions
        </div>
        <div class="panel-tab" data-panel="docs" onclick="switchPanel('docs')">
          Docs
        </div>
      </div>
      <div class="panel-content" id="panelContent">
        <div class="empty-state">
          <div class="empty-state-icon">‚úì</div>
          <div>No validation issues found<br><small>Click "Validate" to check your compose file</small></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Schema definition
  const schema = {
    version: { type: 'string', desc: 'Compose file version', suggestions: ['3.8', '3.9', '3'] },
    services: {
      type: 'object',
      desc: 'Service definitions',
      children: 'custom',
      customChild: {
        image: { type: 'string', desc: 'Docker image', suggestions: ['nginx:alpine', 'postgres:15', 'redis:alpine', 'node:18-alpine'] },
        container_name: { type: 'string', desc: 'Container name' },
        build: {
          type: 'object',
          desc: 'Build configuration',
          children: {
            context: { type: 'string', desc: 'Build context path', suggestions: ['.', './backend', './frontend'] },
            dockerfile: { type: 'string', desc: 'Dockerfile name', suggestions: ['Dockerfile', 'Dockerfile.prod'] },
            args: { type: 'array', desc: 'Build arguments' }
          }
        },
        ports: { type: 'array', desc: 'Port mappings (host:container)', suggestions: ['3000:3000', '80:80', '5432:5432', '8080:8080'] },
        environment: { type: 'array', desc: 'Environment variables', suggestions: ['NODE_ENV=production', 'DEBUG=true', 'DATABASE_URL='] },
        volumes: { type: 'array', desc: 'Volume mappings', suggestions: ['./data:/app/data', './logs:/var/log', './config:/etc/config'] },
        networks: { type: 'array', desc: 'Network connections' },
        depends_on: { type: 'array', desc: 'Service dependencies' },
        restart: { type: 'string', desc: 'Restart policy', suggestions: ['always', 'on-failure', 'unless-stopped', 'no'] },
        command: { type: 'string', desc: 'Override default command', suggestions: ['npm start', 'python app.py'] },
        entrypoint: { type: 'string', desc: 'Override entrypoint' },
        healthcheck: {
          type: 'object',
          desc: 'Health check configuration',
          children: {
            test: { type: 'string', desc: 'Health check command', suggestions: ['CMD curl -f http://localhost/ || exit 1', 'CMD-SHELL pg_isready'] },
            interval: { type: 'string', desc: 'Check interval', suggestions: ['30s', '1m', '2m'] },
            timeout: { type: 'string', desc: 'Check timeout', suggestions: ['10s', '30s'] },
            retries: { type: 'string', desc: 'Max retries', suggestions: ['3', '5', '10'] }
          }
        },
        deploy: {
          type: 'object',
          desc: 'Deploy configuration',
          children: {
            replicas: { type: 'string', desc: 'Number of replicas', suggestions: ['1', '2', '3', '5'] },
            resources: {
              type: 'object',
              desc: 'Resource limits',
              children: {
                limits: {
                  type: 'object',
                  desc: 'Resource limits',
                  children: {
                    cpus: { type: 'string', desc: 'CPU limit', suggestions: ['0.5', '1', '2'] },
                    memory: { type: 'string', desc: 'Memory limit', suggestions: ['256M', '512M', '1G', '2G'] }
                  }
                }
              }
            }
          }
        }
      }
    },
    networks: {
      type: 'object',
      desc: 'Network definitions',
      children: 'custom',
      customChild: {
        driver: { type: 'string', desc: 'Network driver', suggestions: ['bridge', 'overlay', 'host', 'none'] },
        external: { type: 'boolean', desc: 'Use external network', suggestions: ['true', 'false'] },
        name: { type: 'string', desc: 'Network name' }
      }
    },
    volumes: {
      type: 'object',
      desc: 'Volume definitions',
      children: 'custom',
      customChild: {
        driver: { type: 'string', desc: 'Volume driver', suggestions: ['local', 'nfs'] },
        external: { type: 'boolean', desc: 'Use external volume', suggestions: ['true', 'false'] }
      }
    },
    configs: {
      type: 'object',
      desc: 'Config definitions',
      children: 'custom',
      customChild: {
        file: { type: 'string', desc: 'Config file path' },
        external: { type: 'boolean', desc: 'Use external config', suggestions: ['true', 'false'] }
      }
    },
    secrets: {
      type: 'object',
      desc: 'Secret definitions',
      children: 'custom',
      customChild: {
        file: { type: 'string', desc: 'Secret file path' },
        external: { type: 'boolean', desc: 'Use external secret', suggestions: ['true', 'false'] },
        name: { type: 'string', desc: 'Secret name' }
      }
    }
  };

  // Data
  let composeData = {
    version: '3.8',
    services: {
      nexus: {
        image: 'sonatype/nexus3',
        container_name: 'nexus',
        ports: ['8081:8081'],
        networks: ['nexus-network'],
        restart: 'always'
      }
    },
    networks: {
      'nexus-network': {
        driver: 'bridge'
      }
    }
  };

  let collapsedNodes = new Set();
  let currentPanel = 'validation';
  let lineCounter = 1;

  // Render editor
  function renderEditor() {
    const container = document.getElementById('editorContent');
    container.innerHTML = '';
    lineCounter = 1;
    renderObject(composeData, 0, '', []);
    validateLocal();
  }

  function renderObject(obj, indent, parentKey, path) {
    Object.entries(obj).forEach(([key, value]) => {
      const currentPath = [...path, key];
      const pathStr = currentPath.join('.');
      const isCollapsed = collapsedNodes.has(pathStr);
      const isObject = typeof value === 'object' && value !== null && !Array.isArray(value);
      const isArray = Array.isArray(value);

      // Create line
      const line = document.createElement('div');
      line.className = 'yaml-line';
      line.dataset.path = pathStr;

      // Line number
      const lineNum = document.createElement('div');
      lineNum.className = 'line-number';
      lineNum.textContent = lineCounter++;
      line.appendChild(lineNum);

      // Line content
      const content = document.createElement('div');
      content.className = 'line-content';

      // Indent
      content.style.paddingLeft = (indent * 20) + 'px';

      // Collapse button
      if ((isObject && Object.keys(value).length > 0) || (isArray && value.length > 0)) {
        const collapseBtn = document.createElement('span');
        collapseBtn.className = 'collapse-btn';
        collapseBtn.textContent = isCollapsed ? '‚ñ∂' : '‚ñº';
        collapseBtn.onclick = () => toggleCollapse(pathStr);
        content.appendChild(collapseBtn);
      } else {
        const spacer = document.createElement('span');
        spacer.style.width = '20px';
        spacer.style.display = 'inline-block';
        content.appendChild(spacer);
      }

      // Key
      const keySpan = document.createElement('span');
      keySpan.className = 'key';
      keySpan.textContent = key;
      keySpan.title = getSchemaDesc(parentKey, key);
      content.appendChild(keySpan);

      const colon = document.createElement('span');
      colon.className = 'colon';
      colon.textContent = ':';
      content.appendChild(colon);

      // Value handling
      if (isArray) {
        const addBtn = document.createElement('span');
        addBtn.className = 'add-btn';
        addBtn.textContent = '+ Add';
        addBtn.onclick = () => addArrayItem(currentPath);
        content.appendChild(addBtn);

        if (indent > 0) {
          const deleteBtn = document.createElement('span');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = '√ó Delete';
          deleteBtn.onclick = () => deleteProperty(path, key);
          content.appendChild(deleteBtn);
        }

        line.appendChild(content);
        document.getElementById('editorContent').appendChild(line);

        if (!isCollapsed) {
          value.forEach((item, idx) => {
            const itemLine = document.createElement('div');
            itemLine.className = 'yaml-line';

            const itemLineNum = document.createElement('div');
            itemLineNum.className = 'line-number';
            itemLineNum.textContent = lineCounter++;
            itemLine.appendChild(itemLineNum);

            const itemContent = document.createElement('div');
            itemContent.className = 'line-content';
            itemContent.style.paddingLeft = ((indent + 1) * 20) + 'px';

            const dash = document.createElement('span');
            dash.className = 'array-dash';
            dash.textContent = '-';
            itemContent.appendChild(dash);

            const input = document.createElement('input');
            input.className = 'value-input';
            input.value = item;
            input.onchange = (e) => updateArrayItem(currentPath, idx, e.target.value);
            input.onfocus = (e) => showAutocomplete(e, key, parentKey, currentPath);
            itemContent.appendChild(input);

            const delBtn = document.createElement('span');
            delBtn.className = 'delete-btn';
            delBtn.textContent = '√ó';
            delBtn.onclick = () => deleteArrayItem(currentPath, idx);
            itemContent.appendChild(delBtn);

            itemLine.appendChild(itemContent);
            document.getElementById('editorContent').appendChild(itemLine);
          });
        }
      } else if (isObject) {
        const addBtn = document.createElement('span');
        addBtn.className = 'add-btn';
        addBtn.textContent = '+ Add';
        addBtn.onclick = (e) => showAddMenu(e, currentPath, key);
        content.appendChild(addBtn);

        if (indent > 0) {
          const deleteBtn = document.createElement('span');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = '√ó Delete';
          deleteBtn.onclick = () => deleteProperty(path, key);
          content.appendChild(deleteBtn);
        }

        line.appendChild(content);
        document.getElementById('editorContent').appendChild(line);

        if (!isCollapsed) {
          renderObject(value, indent + 1, key, currentPath);
        }
      } else {
        const input = document.createElement('input');
        input.className = 'value-input';
        input.value = value || '';
        input.onchange = (e) => updateValue(currentPath, e.target.value);
        input.onfocus = (e) => showAutocomplete(e, key, parentKey, currentPath);
        content.appendChild(input);

        if (indent > 1) {
          const deleteBtn = document.createElement('span');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = '√ó';
          deleteBtn.onclick = () => deleteProperty(path, key);
          content.appendChild(deleteBtn);
        }

        line.appendChild(content);
        document.getElementById('editorContent').appendChild(line);
      }
    });
  }

  function getSchemaDesc(parentKey, key) {
    let sch = schema[parentKey];
    if (sch?.children === 'custom') {
      return sch.customChild[key]?.desc || '';
    }
    if (sch?.children) {
      return sch.children[key]?.desc || '';
    }
    return schema[key]?.desc || '';
  }

  function toggleCollapse(pathStr) {
    if (collapsedNodes.has(pathStr)) {
      collapsedNodes.delete(pathStr);
    } else {
      collapsedNodes.add(pathStr);
    }
    renderEditor();
  }

  function updateValue(path, value) {
    let obj = composeData;
    for (let i = 0; i < path.length - 1; i++) {
      obj = obj[path[i]];
    }
    obj[path[path.length - 1]] = value;
    validateLocal();
  }

  function addArrayItem(path) {
    let obj = composeData;
    for (let i = 0; i < path.length; i++) {
      obj = obj[path[i]];
    }
    if (Array.isArray(obj)) {
      obj.push('');
      renderEditor();
    }
  }

  function updateArrayItem(path, index, value) {
    let obj = composeData;
    for (let i = 0; i < path.length; i++) {
      obj = obj[path[i]];
    }
    if (Array.isArray(obj)) {
      obj[index] = value;
      validateLocal();
    }
  }

  function deleteArrayItem(path, index) {
    let obj = composeData;
    for (let i = 0; i < path.length; i++) {
      obj = obj[path[i]];
    }
    if (Array.isArray(obj)) {
      obj.splice(index, 1);
      renderEditor();
    }
  }

  function deleteProperty(parentPath, key) {
    let obj = composeData;
    for (let i = 0; i < parentPath.length; i++) {
      obj = obj[parentPath[i]];
    }
    delete obj[key];
    renderEditor();
  }

  function showAddMenu(event, path, parentKey) {
    event.stopPropagation();
    closeAutocomplete();

    let obj = composeData;
    for (let i = 0; i < path.length; i++) {
      obj = obj[path[i]];
    }

    let sch = schema[parentKey];
    if (!sch && path.length > 1) {
      // Navigate deeper in schema
      for (let i = 1; i < path.length; i++) {
        const k = path[i];
        if (sch?.children === 'custom') {
          sch = sch.customChild;
          break;
        } else if (sch?.children) {
          sch = sch.children[k];
        }
      }
    }

    const rect = event.target.getBoundingClientRect();
    const popup = document.createElement('div');
    popup.className = 'autocomplete-popup';
    popup.id = 'autocompletePopup';
    popup.style.left = rect.left + 'px';
    popup.style.top = (rect.bottom + 5) + 'px';

    if (sch?.children === 'custom') {
      // Custom keys allowed
      const existingKeys = Object.keys(obj);
      const availableKeys = Object.keys(sch.customChild).filter(k => !existingKeys.includes(k));

      const customItem = createAutocompleteItem(
        '+ Custom property',
        'Enter custom property name',
        'string',
        () => {
          const name = prompt('Enter property name:');
          if (name && name.trim()) {
            obj[name.trim()] = '';
            renderEditor();
          }
          closeAutocomplete();
        }
      );
      popup.appendChild(customItem);

      availableKeys.forEach(key => {
        const def = sch.customChild[key];
        const item = createAutocompleteItem(
          key,
          def.desc,
          def.type,
          () => {
            if (def.type === 'object') {
              obj[key] = {};
            } else if (def.type === 'array') {
              obj[key] = [];
            } else {
              obj[key] = def.suggestions ? def.suggestions[0] : '';
            }
            renderEditor();
            closeAutocomplete();
          }
        );
        popup.appendChild(item);
      });
    } else if (sch?.children) {
      const existingKeys = Object.keys(obj);
      const availableKeys = Object.entries(sch.children).filter(([k]) => !existingKeys.includes(k));

      availableKeys.forEach(([key, def]) => {
        const item = createAutocompleteItem(
          key,
          def.desc,
          def.type,
          () => {
            if (def.type === 'object') {
              obj[key] = {};
            } else if (def.type === 'array') {
              obj[key] = [];
            } else {
              obj[key] = def.suggestions ? def.suggestions[0] : '';
            }
            renderEditor();
            closeAutocomplete();
          }
        );
        popup.appendChild(item);
      });
    }

    document.body.appendChild(popup);
  }

  function showAutocomplete(event, key, parentKey, path) {
    closeAutocomplete();

    let sch = schema[parentKey];
    if (sch?.children === 'custom') {
      sch = sch.customChild[key];
    } else if (sch?.children) {
      sch = sch.children[key];
    } else {
      sch = schema[key];
    }

    if (!sch?.suggestions || sch.suggestions.length === 0) return;

    const rect = event.target.getBoundingClientRect();
    const popup = document.createElement('div');
    popup.className = 'autocomplete-popup';
    popup.id = 'autocompletePopup';
    popup.style.left = rect.left + 'px';
    popup.style.top = (rect.bottom + 5) + 'px';

    sch.suggestions.forEach(sug => {
      const item = document.createElement('div');
      item.className = 'autocomplete-item';
      item.textContent = sug;
      item.style.color = '#ce9178';
      item.onclick = () => {
        event.target.value = sug;
        event.target.dispatchEvent(new Event('change'));
        closeAutocomplete();
      };
      popup.appendChild(item);
    });

    document.body.appendChild(popup);
  }

  function createAutocompleteItem(key, desc, type, onclick) {
    const item = document.createElement('div');
    item.className = 'autocomplete-item';
    item.onclick = onclick;

    const keyDiv = document.createElement('div');
    keyDiv.className = 'autocomplete-key';
    keyDiv.textContent = key;
    item.appendChild(keyDiv);

    const descDiv = document.createElement('div');
    descDiv.className = 'autocomplete-desc';
    descDiv.textContent = desc;
    item.appendChild(descDiv);

    const typeDiv = document.createElement('div');
    typeDiv.className = 'autocomplete-type';
    typeDiv.textContent = `Type: ${type}`;
    item.appendChild(typeDiv);

    return item;
  }

  function closeAutocomplete() {
    const existing = document.getElementById('autocompletePopup');
    if (existing) existing.remove();
  }

  // Click outside to close
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.autocomplete-popup') && !e.target.closest('.add-btn')) {
      closeAutocomplete();
    }
  });

  // Local validation
  function validateLocal() {
    const issues = [];

    if (composeData.services) {
      Object.entries(composeData.services).forEach(([name, service]) => {
        if (!service.image && !service.build) {
          issues.push({
            type: 'error',
            msg: `Service "${name}" must have either "image" or "build"`,
            line: name
          });
        }

        if (service.networks && Array.isArray(service.networks)) {
          service.networks.forEach(net => {
            if (net && !composeData.networks?.[net]) {
              issues.push({
                type: 'warning',
                msg: `Network "${net}" is not defined in networks section`,
                line: name
              });
            }
          });
        }

        if (service.volumes && Array.isArray(service.volumes)) {
          service.volumes.forEach(vol => {
            if (vol && !vol.includes(':')) {
              issues.push({
                type: 'warning',
                msg: `Volume "${vol}" should be in format "host:container"`,
                line: name
              });
            }
          });
        }

        if (service.ports && Array.isArray(service.ports)) {
          service.ports.forEach(port => {
            if (port && !port.includes(':')) {
              issues.push({
                type: 'warning',
                msg: `Port "${port}" should be in format "host:container"`,
                line: name
              });
            }
          });
        }
      });
    }

    if (currentPanel === 'validation' && issues.length === 0) {
      showEmptyValidation();
    } else if (currentPanel === 'validation') {
      showIssues(issues);
    }

    return issues;
  }

  // AI Validation
  async function validateWithAI() {
    const btn = document.getElementById('validateBtn');
    btn.disabled = true;
    btn.innerHTML = '<span>‚è≥</span> Validating...';

    switchPanel('validation');
    showLoading('Validating with AI...');

    try {
      const yaml = toYAML(composeData);
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          messages: [{
            role: 'user',
            content: `You are a Docker Compose expert. Validate this docker-compose.yml file and find any errors, misconfigurations, security issues, or best practice violations.

Return ONLY a JSON array with this exact format, no markdown, no other text:
[
  {"type": "error", "msg": "description", "line": "service_name"},
  {"type": "warning", "msg": "description", "line": "service_name"}
]

Docker Compose file:
${yaml}`
          }]
        })
      });

      const result = await response.json();
      const text = result.content[0].text;

      // Try to extract JSON from response
      const jsonMatch = text.match(/\[[\s\S]*\]/);
      if (jsonMatch) {
        const issues = JSON.parse(jsonMatch[0]);
        showIssues(issues);
      } else {
        showIssues([{ type: 'error', msg: 'Could not parse AI response', line: '' }]);
      }
    } catch (err) {
      console.error(err);
      showIssues([{ type: 'error', msg: 'AI validation failed: ' + err.message, line: '' }]);
    }

    btn.disabled = false;
    btn.innerHTML = '<span>‚úì</span> Validate';
  }

  // AI Suggestions
  async function getSuggestions() {
    const btn = document.getElementById('suggestBtn');
    btn.disabled = true;
    btn.innerHTML = '<span>‚è≥</span> Getting...';

    switchPanel('suggestions');
    showLoading('Getting AI suggestions...');

    try {
      const yaml = toYAML(composeData);
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          messages: [{
            role: 'user',
            content: `You are a Docker Compose expert. Analyze this docker-compose.yml file and suggest improvements for:
- Security best practices
- Performance optimization
- Resource management
- Missing important configurations
- Production readiness

Return ONLY a JSON array with this exact format, no markdown:
[
  {"title": "Short title", "desc": "Detailed description"},
  {"title": "Another suggestion", "desc": "Explanation"}
]

Docker Compose file:
${yaml}`
          }]
        })
      });

      const result = await response.json();
      const text = result.content[0].text;

      const jsonMatch = text.match(/\[[\s\S]*\]/);
      if (jsonMatch) {
        const suggestions = JSON.parse(jsonMatch[0]);
        showSuggestions(suggestions);
      } else {
        showSuggestions([{ title: 'Error', desc: 'Could not parse AI response' }]);
      }
    } catch (err) {
      console.error(err);
      showSuggestions([{ title: 'Error', desc: 'AI suggestions failed: ' + err.message }]);
    }

    btn.disabled = false;
    btn.innerHTML = '<span>üí°</span> AI Suggestions';
  }

  // Panel functions
  function switchPanel(panel) {
    currentPanel = panel;
    document.querySelectorAll('.panel-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelector(`.panel-tab[data-panel="${panel}"]`).classList.add('active');

    if (panel === 'validation') {
      const issues = validateLocal();
      if (issues.length === 0) {
        showEmptyValidation();
      } else {
        showIssues(issues);
      }
    } else if (panel === 'suggestions') {
      showEmptySuggestions();
    } else if (panel === 'docs') {
      showDocs();
    }
  }

  function showLoading(message) {
    const content = document.getElementById('panelContent');
    content.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <div>${message}</div>
      </div>
    `;
  }

  function showEmptyValidation() {
    const content = document.getElementById('panelContent');
    content.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">‚úì</div>
        <div>No validation issues found<br><small>Your compose file looks good!</small></div>
      </div>
    `;
  }

  function showEmptySuggestions() {
    const content = document.getElementById('panelContent');
    content.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üí°</div>
        <div>No suggestions yet<br><small>Click "AI Suggestions" to get recommendations</small></div>
      </div>
    `;
  }

  function showIssues(issues) {
    const content = document.getElementById('panelContent');
    if (issues.length === 0) {
      showEmptyValidation();
      return;
    }

    content.innerHTML = issues.map(issue => `
      <div class="issue-item ${issue.type === 'warning' ? 'warning' : ''}">
        <div class="issue-title">
          ${issue.type === 'error' ? '‚õî' : '‚ö†Ô∏è'}
          ${issue.type}
        </div>
        <div class="issue-message">${issue.msg}</div>
        ${issue.line ? `<div class="issue-line">Line: ${issue.line}</div>` : ''}
      </div>
    `).join('');
  }

  function showSuggestions(suggestions) {
    const content = document.getElementById('panelContent');
    if (suggestions.length === 0) {
      showEmptySuggestions();
      return;
    }

    content.innerHTML = suggestions.map(sug => `
      <div class="suggestion-item">
        <div class="suggestion-title">${sug.title}</div>
        <div class="suggestion-desc">${sug.desc}</div>
      </div>
    `).join('');
  }

  function showDocs() {
    const content = document.getElementById('panelContent');
    content.innerHTML = `
      <div class="docs-section">
        <div class="docs-title">üöÄ Quick Start</div>
        <div class="docs-content">
          <ul style="list-style: none; padding: 0;">
            <li>‚Ä¢ Click <strong>+ Add</strong> button to add new properties</li>
            <li>‚Ä¢ Click <strong>√ó Delete</strong> to remove properties</li>
            <li>‚Ä¢ Click <strong>‚ñ∂/‚ñº</strong> to collapse/expand sections</li>
            <li>‚Ä¢ Focus on inputs to see autocomplete suggestions</li>
          </ul>
        </div>
      </div>

      <div class="docs-section">
        <div class="docs-title">üí° Features</div>
        <div class="docs-content">
          <ul style="list-style: none; padding: 0;">
            <li><strong>‚úì Validate</strong> - AI-powered validation for errors and security issues</li>
            <li><strong>üí° AI Suggestions</strong> - Get best practice recommendations</li>
            <li><strong>üìã Templates</strong> - Load common service configurations</li>
            <li><strong>‚¨á Export</strong> - Download your docker-compose.yml file</li>
          </ul>
        </div>
      </div>

      <div class="docs-section">
        <div class="docs-title">üìù Common Patterns</div>
        <div class="docs-content">
          <strong>Port mapping:</strong>
          <div class="code-example">8080:80</div>

          <strong>Environment variable:</strong>
          <div class="code-example">NODE_ENV=production</div>

          <strong>Volume mounting:</strong>
          <div class="code-example">./data:/app/data</div>
        </div>
      </div>

      <div class="docs-section">
        <div class="docs-title">üîó Documentation</div>
        <div class="docs-content">
          <ul style="list-style: none; padding: 0;">
            <li>‚Ä¢ <a href="https://docs.docker.com/compose/" target="_blank" style="color: #4ec9b0;">Docker Compose Docs</a></li>
            <li>‚Ä¢ <a href="https://docs.docker.com/compose/compose-file/" target="_blank" style="color: #4ec9b0;">Compose File Reference</a></li>
          </ul>
        </div>
      </div>
    `;
  }

  // Export YAML
  function toYAML(obj, indent = 0) {
    let yaml = '';
    Object.entries(obj).forEach(([key, val]) => {
      yaml += '  '.repeat(indent) + key + ':';
      if (Array.isArray(val)) {
        if (val.length === 0) {
          yaml += ' []\n';
        } else {
          yaml += '\n';
          val.forEach(item => {
            yaml += '  '.repeat(indent + 1) + '- ' + item + '\n';
          });
        }
      } else if (typeof val === 'object' && val !== null) {
        if (Object.keys(val).length === 0) {
          yaml += ' {}\n';
        } else {
          yaml += '\n' + toYAML(val, indent + 1);
        }
      } else {
        yaml += ' ' + val + '\n';
      }
    });
    return yaml;
  }

  function exportYAML() {
    const yaml = toYAML(composeData);
    const blob = new Blob([yaml], { type: 'text/yaml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'docker-compose.yml';
    a.click();
    URL.revokeObjectURL(url);
  }

  // Templates
  function loadTemplates() {
    const templates = {
      'Full Stack App': {
        version: '3.8',
        services: {
          frontend: {
            build: { context: './frontend', dockerfile: 'Dockerfile' },
            ports: ['3000:3000'],
            environment: ['NODE_ENV=production'],
            depends_on: ['backend']
          },
          backend: {
            build: { context: './backend' },
            ports: ['5000:5000'],
            environment: ['DATABASE_URL=postgres://user:pass@db:5432/mydb'],
            depends_on: ['db']
          },
          db: {
            image: 'postgres:15-alpine',
            ports: ['5432:5432'],
            environment: ['POSTGRES_DB=mydb', 'POSTGRES_USER=user', 'POSTGRES_PASSWORD=pass'],
            volumes: ['./postgres-data:/var/lib/postgresql/data']
          }
        },
        networks: { 'app-network': { driver: 'bridge' } }
      },
      'NGINX + App': {
        version: '3.8',
        services: {
          nginx: {
            image: 'nginx:alpine',
            ports: ['80:80'],
            volumes: ['./nginx.conf:/etc/nginx/nginx.conf'],
            depends_on: ['app']
          },
          app: {
            image: 'node:18-alpine',
            ports: ['3000:3000'],
            environment: ['NODE_ENV=production'],
            restart: 'always'
          }
        }
      },
      'Database Cluster': {
        version: '3.8',
        services: {
          postgres: {
            image: 'postgres:15',
            environment: ['POSTGRES_PASSWORD=secret'],
            volumes: ['db-data:/var/lib/postgresql/data']
          },
          redis: {
            image: 'redis:alpine',
            ports: ['6379:6379']
          }
        },
        volumes: { 'db-data': {} }
      }
    };

    const choice = prompt('Choose template:\n1. Full Stack App\n2. NGINX + App\n3. Database Cluster\n\nEnter 1, 2, or 3:');
    const templateNames = ['Full Stack App', 'NGINX + App', 'Database Cluster'];
    const selected = templateNames[parseInt(choice) - 1];

    if (selected && templates[selected]) {
      composeData = JSON.parse(JSON.stringify(templates[selected]));
      renderEditor();
    }
  }

  // Initialize
  renderEditor();
</script>
</body>
</html>
