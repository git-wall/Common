<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dockerfile Generator - Java/Spring</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
      color: #e0e0e0;
      min-height: 100vh;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-height: 100vh;
    }

    header {
      text-align: center;
      padding: 20px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    h1 {
      font-size: 2.5em;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #a0a0a0;
      font-size: 1.1em;
    }

    .main-content {
      display: flex;
      gap: 20px;
      flex: 1;
      min-height: 800px;
    }

    .sidebar {
      width: 300px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
    }

    .config-categories {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }

    .category-item {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid transparent;
    }

    .category-item:hover {
      background: rgba(102, 126, 234, 0.15);
      transform: translateX(5px);
    }

    .category-item.active {
      background: rgba(102, 126, 234, 0.25);
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .category-name {
      font-weight: 500;
      color: #e0e0e0;
    }

    .config-items {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .config-group {
      margin-bottom: 20px;
    }

    .group-title {
      color: #4CAF50;
      font-weight: 600;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(76, 175, 80, 0.3);
      font-size: 1.1em;
    }

    .config-item {
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: move;
      transition: all 0.3s;
      border: 1px solid transparent;
      user-select: none;
    }

    .config-item:hover {
      background: rgba(102, 126, 234, 0.2);
      border-color: #667eea;
      transform: translateX(5px);
    }

    .config-item-title {
      font-weight: 500;
      color: #e0e0e0;
      margin-bottom: 5px;
    }

    .config-item-desc {
      font-size: 0.85em;
      color: #a0a0a0;
    }

    .optimization-tips {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      border-left: 4px solid #FF9800;
    }

    .optimization-title {
      color: #FF9800;
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .optimization-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.9em;
      color: #b0b0b0;
      cursor: pointer;
      transition: all 0.2s;
    }

    .optimization-item:hover {
      color: #FF9800;
      padding-left: 5px;
    }

    .config-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .code-editor {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .editor-title {
      font-size: 1.4em;
      color: #667eea;
    }

    .editor-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      background: rgba(102, 126, 234, 0.2);
      border: 1px solid #667eea;
      color: #667eea;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      font-size: 0.9em;
    }

    .action-btn:hover {
      background: rgba(102, 126, 234, 0.3);
      transform: translateY(-2px);
    }

    .action-btn.copy {
      background: rgba(76, 175, 80, 0.2);
      border-color: #4CAF50;
      color: #4CAF50;
    }

    .action-btn.copy:hover {
      background: rgba(76, 175, 80, 0.3);
    }

    .action-btn.reset {
      background: rgba(244, 67, 54, 0.2);
      border-color: #f44336;
      color: #f44336;
    }

    .action-btn.reset:hover {
      background: rgba(244, 67, 54, 0.3);
    }

    .action-btn.ai-validate {
      background: rgba(156, 39, 176, 0.2);
      border-color: #9C27B0;
      color: #9C27B0;
    }

    .action-btn.ai-validate:hover {
      background: rgba(156, 39, 176, 0.3);
    }

    .code-area {
      flex: 1;
      position: relative;
      min-height: 600px;
    }

    #dockerfileEditor {
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      color: #a8dadc;
      white-space: pre;
      overflow-x: auto;
      resize: none;
      tab-size: 4;
    }

    #dockerfileEditor:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }

    .drop-indicator {
      position: absolute;
      height: 2px;
      background: #667eea;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
    }

    .drop-indicator.active {
      opacity: 1;
    }

    .error-highlight {
      background: rgba(244, 67, 54, 0.5);
      border-left: 3px solid #f44336;
      border-right: 3px solid #f44336;
      margin: 2px -5px;
      padding: 2px 5px;
      animation: pulse 2s infinite;
    }

    .warning-highlight {
      background: rgba(255, 152, 0, 0.4);
      border-left: 3px solid #FF9800;
      border-right: 3px solid #FF9800;
      margin: 2px -5px;
      padding: 2px 5px;
    }

    .success-highlight {
      background: rgba(76, 175, 80, 0.3);
      border-left: 3px solid #4CAF50;
      border-right: 3px solid #4CAF50;
      margin: 2px -5px;
      padding: 2px 5px;
    }

    .info-highlight {
      background: rgba(33, 150, 243, 0.3);
      border-left: 3px solid #2196F3;
      border-right: 3px solid #2196F3;
      margin: 2px -5px;
      padding: 2px 5px;
    }

    @keyframes pulse {
      0%, 100% { background-color: rgba(244, 67, 54, 0.5); }
      50% { background-color: rgba(244, 67, 54, 0.8); }
    }

    .validation-panel {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-height: 300px;
      overflow-y: auto;
    }

    .validation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .validation-title {
      font-size: 1.2em;
      color: #667eea;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .validation-status {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 500;
    }

    .status-success {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }

    .status-warning {
      background: rgba(255, 152, 0, 0.2);
      color: #FF9800;
    }

    .status-error {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }

    .validation-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .validation-item {
      padding: 12px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.2);
      border-left: 4px solid #666;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .validation-item:hover {
      transform: translateX(5px);
    }

    .validation-item.error {
      border-left-color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }

    .validation-item.warning {
      border-left-color: #FF9800;
      background: rgba(255, 152, 0, 0.1);
    }

    .validation-item.info {
      border-left-color: #2196F3;
      background: rgba(33, 150, 243, 0.1);
    }

    .validation-item.success {
      border-left-color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }

    .validation-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .validation-type {
      font-weight: 600;
      font-size: 0.9em;
    }

    .validation-line {
      font-size: 0.85em;
      color: #888;
    }

    .validation-message {
      font-size: 0.95em;
      line-height: 1.4;
    }

    .validation-suggestion {
      margin-top: 8px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      font-size: 0.9em;
      color: #a0a0a0;
      border-left: 3px solid #667eea;
    }

    .ai-thinking {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 20px;
      color: #9C27B0;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 100;
      border-radius: 8px;
    }

    .ai-thinking.active {
      display: flex;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(156, 39, 176, 0.3);
      border-radius: 50%;
      border-top-color: #9C27B0;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .syntax-guide {
      margin-top: 15px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      font-size: 0.9em;
      color: #a0a0a0;
    }

    .syntax-title {
      color: #667eea;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .syntax-rule {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .syntax-rule:last-child {
      border-bottom: none;
    }

    .rule-valid {
      color: #4CAF50;
    }

    .rule-invalid {
      color: #f44336;
    }

    footer {
      text-align: center;
      padding: 20px 0;
      color: #a0a0a0;
      font-size: 0.9em;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 20px;
    }

    .drag-handle {
      cursor: move;
      padding: 5px;
      color: #666;
      font-size: 1.2em;
    }

    .config-item.dragging {
      opacity: 0.5;
      background: rgba(102, 126, 234, 0.3);
    }

    .code-highlight {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
      padding: 20px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre;
      overflow: hidden;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 255, 0.7);
    }

    @media (max-width: 1024px) {
      .main-content {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>üê≥ Dockerfile Generator - Java/Spring</h1>
    <p class="subtitle">T·∫°o Dockerfile t·ªëi ∆∞u v·ªõi AI validation</p>
  </header>

  <div class="main-content">
    <!-- Sidebar v·ªõi danh s√°ch config items -->
    <div class="sidebar">
      <div class="config-categories">
        <div class="category-item active" data-category="basic">
          <span class="category-name">C·∫•u H√¨nh C∆° B·∫£n</span>
        </div>
        <div class="category-item" data-category="build">
          <span class="category-name">Build & Dependencies</span>
        </div>
        <div class="category-item" data-category="optimization">
          <span class="category-name">T·ªëi ∆Øu H√≥a Java</span>
        </div>
        <div class="category-item" data-category="security">
          <span class="category-name">B·∫£o M·∫≠t</span>
        </div>
      </div>

      <div class="config-items" id="configItems">
        <!-- C·∫•u h√¨nh c∆° b·∫£n -->
        <div class="config-group" id="group-basic">
          <div class="group-title">C·∫•u H√¨nh C∆° B·∫£n</div>
          <div class="config-item" data-type="FROM" data-template="FROM {{baseImage}}">
            <div class="config-item-title">FROM (Base Image)</div>
            <div class="config-item-desc">Base image cho container</div>
          </div>
          <div class="config-item" data-type="WORKDIR" data-template="WORKDIR {{workdir}}">
            <div class="config-item-title">WORKDIR</div>
            <div class="config-item-desc">Th∆∞ m·ª•c l√†m vi·ªác trong container</div>
          </div>
          <div class="config-item" data-type="COPY" data-template="COPY {{source}} {{destination}}">
            <div class="config-item-title">COPY Files</div>
            <div class="config-item-desc">Sao ch√©p file v√†o container</div>
          </div>
          <div class="config-item" data-type="EXPOSE" data-template="EXPOSE {{port}}">
            <div class="config-item-title">EXPOSE Port</div>
            <div class="config-item-desc">Expose port c·ªßa ·ª©ng d·ª•ng</div>
          </div>
        </div>

        <!-- Build & Dependencies -->
        <div class="config-group" id="group-build">
          <div class="group-title">Build & Dependencies</div>
          <div class="config-item" data-type="RUN" data-template="RUN {{command}}">
            <div class="config-item-title">RUN Commands</div>
            <div class="config-item-desc">Ch·∫°y l·ªánh trong container</div>
          </div>
          <div class="config-item" data-type="ENV" data-template="ENV {{key}}={{value}}">
            <div class="config-item-title">ENV Variables</div>
            <div class="config-item-desc">Bi·∫øn m√¥i tr∆∞·ªùng</div>
          </div>
        </div>

        <!-- T·ªëi ∆∞u h√≥a Java -->
        <div class="config-group" id="group-optimization">
          <div class="group-title">T·ªëi ∆Øu H√≥a Java</div>
          <div class="config-item" data-type="JVM_OPTIONS" data-template="-XX:+UseContainerSupport">
            <div class="config-item-title">JVM Options</div>
            <div class="config-item-desc">T·ªëi ∆∞u h√≥a JVM cho container</div>
          </div>
          <div class="config-item" data-type="ZGC" data-template="-XX:+UseZGC">
            <div class="config-item-title">Z Garbage Collector</div>
            <div class="config-item-desc">S·ª≠ d·ª•ng ZGC cho low latency</div>
          </div>
          <div class="config-item" data-type="G1GC" data-template="-XX:+UseG1GC">
            <div class="config-item-title">G1 Garbage Collector</div>
            <div class="config-item-desc">S·ª≠ d·ª•ng G1GC balanced</div>
          </div>
          <div class="config-item" data-type="MEMORY_OPT" data-template="-XX:MaxRAMPercentage=75.0">
            <div class="config-item-title">Memory Optimization</div>
            <div class="config-item-desc">T·ªëi ∆∞u b·ªô nh·ªõ cho container</div>
          </div>
        </div>

        <!-- B·∫£o m·∫≠t -->
        <div class="config-group" id="group-security">
          <div class="group-title">B·∫£o M·∫≠t</div>
          <div class="config-item" data-type="USER" data-template="USER {{username}}">
            <div class="config-item-title">Non-root User</div>
            <div class="config-item-desc">Ch·∫°y v·ªõi non-root user</div>
          </div>
          <div class="config-item" data-type="HEALTHCHECK" data-template="HEALTHCHECK CMD curl -f http://localhost:{{port}}/health || exit 1">
            <div class="config-item-title">Health Check</div>
            <div class="config-item-desc">Ki·ªÉm tra s·ª©c kh·ªèe container</div>
          </div>
          <div class="config-item" data-type="ENTRYPOINT" data-template='ENTRYPOINT ["java", "-jar", "app.jar"]'>
            <div class="config-item-title">Entrypoint</div>
            <div class="config-item-desc">Entrypoint c·ªßa container</div>
          </div>
        </div>
      </div>

      <!-- AI Powered Tips -->
      <div class="optimization-tips">
        <div class="optimization-title">ü§ñ AI-Powered Tips</div>
        <div class="optimization-item" onclick="applyAISuggestion('optimize')">
          ‚Ä¢ T·ªëi ∆∞u h√≥a v·ªõi AI
        </div>
        <div class="optimization-item" onclick="applyAISuggestion('security')">
          ‚Ä¢ Ki·ªÉm tra b·∫£o m·∫≠t
        </div>
        <div class="optimization-item" onclick="applyAISuggestion('performance')">
          ‚Ä¢ T·ªëi ∆∞u hi·ªáu nƒÉng
        </div>
        <div class="optimization-item" onclick="applyAISuggestion('multistage')">
          ‚Ä¢ G·ª£i √Ω multi-stage
        </div>
      </div>
    </div>

    <!-- Main panel v·ªõi editor v√† validation -->
    <div class="config-panel">
      <div class="code-editor">
        <div class="editor-header">
          <h2 class="editor-title">Dockerfile Editor</h2>
          <div class="editor-actions">
            <button class="action-btn reset" onclick="resetDockerfile()">
              üîÑ Reset
            </button>
            <button class="action-btn ai-validate" onclick="validateWithAI()">
              ü§ñ AI Validate
            </button>
            <button class="action-btn copy" onclick="copyDockerfile()">
              üìã Copy
            </button>
          </div>
        </div>
        <div class="code-area" id="codeArea">
          <div class="ai-thinking" id="aiThinking">
            <div class="spinner"></div>
            <span>AI ƒëang ph√¢n t√≠ch Dockerfile...</span>
          </div>
          <div class="drop-indicator" id="dropIndicator"></div>
          <div class="code-highlight" id="codeHighlight"></div>
          <textarea id="dockerfileEditor" spellcheck="false">
# Dockerfile Generated by Dockerfile Generator - Java/Spring
# Optimized for production

FROM eclipse-temurin:17-jdk-alpine as builder

WORKDIR /app

COPY . .

RUN ./gradlew clean build -x test

FROM eclipse-temurin:17-jre-alpine

WORKDIR /app

COPY --from=builder /app/build/libs/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]</textarea>
        </div>
      </div>

      <!-- Validation Results Panel -->
      <div class="validation-panel" id="validationPanel">
        <div class="validation-header">
          <div class="validation-title">
            üîç Validation Results
            <span class="validation-status status-success" id="validationStatus">Ch∆∞a ki·ªÉm tra</span>
          </div>
        </div>
        <div class="validation-list" id="validationList">
          <div class="validation-item info">
            <div class="validation-message">
              Nh·∫•n "AI Validate" ƒë·ªÉ ki·ªÉm tra Dockerfile v·ªõi AI
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>Dockerfile Generator with AI Validation ‚Ä¢ S·ª≠ d·ª•ng Ollama Local API ƒë·ªÉ ph√¢n t√≠ch th√¥ng minh</p>
  </footer>
</div>

<script>
  // Configuration - S·ª≠ d·ª•ng Ollama local API
  const API_CONFIG = {
    OLLAMA: {
      url: 'http://localhost:11434/api/chat',
      model: 'phi3:mini', // C√≥ th·ªÉ ƒë·ªïi th√†nh model kh√°c: llama2, mistral, codellama, v.v.
      timeout: 60000 // 60 seconds timeout
    }
  };

  const CURRENT_API = API_CONFIG.OLLAMA;

  // Template data
  const templates = {
    variables: {
      baseImage: { value: 'eclipse-temurin:17-jdk-alpine', description: 'Base image' },
      workdir: { value: '/app', description: 'Working directory' },
      port: { value: '8080', description: 'Application port' },
      source: { value: '.', description: 'Source path' },
      destination: { value: '.', description: 'Destination path' },
      command: { value: './gradlew clean build -x test', description: 'Command' },
      key: { value: 'JAVA_OPTS', description: 'Environment key' },
      value: { value: '-Xmx512m', description: 'Environment value' },
      username: { value: 'appuser', description: 'Non-root username' }
    }
  };

  let dropLine = -1;
  let validationResults = [];
  let currentHighlights = [];

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    setupDragAndDrop();
    setupCategorySwitching();
  });

  function setupCategorySwitching() {
    document.querySelectorAll('.category-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        const category = item.dataset.category;
        document.querySelectorAll('.config-group').forEach(group => {
          group.style.display = 'none';
        });
        document.getElementById(`group-${category}`).style.display = 'block';
      });
    });
  }

  function setupDragAndDrop() {
    const configItems = document.querySelectorAll('.config-item');
    const codeArea = document.getElementById('codeArea');
    const dropIndicator = document.getElementById('dropIndicator');
    const editor = document.getElementById('dockerfileEditor');

    configItems.forEach(item => {
      item.setAttribute('draggable', 'true');

      item.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', JSON.stringify({
          type: item.dataset.type,
          template: item.dataset.template
        }));
        item.classList.add('dragging');
      });

      item.addEventListener('dragend', () => {
        item.classList.remove('dragging');
        dropIndicator.classList.remove('active');
      });
    });

    codeArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      const rect = codeArea.getBoundingClientRect();
      const y = e.clientY - rect.top + editor.scrollTop;

      const lineHeight = 24;
      dropLine = Math.floor(y / lineHeight);

      dropIndicator.style.top = (dropLine * lineHeight) + 'px';
      dropIndicator.style.left = '0';
      dropIndicator.style.width = '100%';
      dropIndicator.classList.add('active');
    });

    codeArea.addEventListener('dragleave', () => {
      dropIndicator.classList.remove('active');
    });

    codeArea.addEventListener('drop', (e) => {
      e.preventDefault();
      dropIndicator.classList.remove('active');

      try {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        if (data.type && data.template) {
          insertCodeAtLine(data.template, dropLine);
          // Auto-validate after drop
          setTimeout(() => validateWithAI(), 1000);
        }
      } catch (error) {
        console.error('Drop error:', error);
      }
    });
  }

  function insertCodeAtLine(template, lineIndex) {
    const editor = document.getElementById('dockerfileEditor');
    const lines = editor.value.split('\n');

    // Replace variables
    let code = template;
    Object.keys(templates.variables).forEach(key => {
      const regex = new RegExp(`{{${key}}}`, 'g');
      code = code.replace(regex, templates.variables[key].value);
    });

    // Insert code
    const codeLines = code.split('\n');

    if (lineIndex >= lines.length) {
      // Append to end
      lines.push(...codeLines);
    } else {
      // Insert at specific line
      lines.splice(lineIndex, 0, ...codeLines);
    }

    editor.value = lines.join('\n');
    highlightLine(lineIndex, 'success', 0, codeLines.length);
  }

  function highlightLine(lineIndex, type, startCol = 0, lineCount = 1) {
    currentHighlights.push({
      line: lineIndex,
      type: type,
      lineCount: lineCount
    });

    updateCodeHighlight();

    // Auto-remove highlights after 3 seconds (for success type)
    if (type === 'success') {
      setTimeout(() => {
        currentHighlights = currentHighlights.filter(h =>
          !(h.line === lineIndex && h.type === 'success')
        );
        updateCodeHighlight();
      }, 3000);
    }
  }

  function updateCodeHighlight() {
    const editor = document.getElementById('dockerfileEditor');
    const highlightDiv = document.getElementById('codeHighlight');
    const lines = editor.value.split('\n');

    let highlightedContent = '';

    lines.forEach((line, index) => {
      const highlights = currentHighlights.filter(h =>
        index >= h.line && index < h.line + h.lineCount
      );

      if (highlights.length > 0) {
        // Use the most severe highlight type
        const highlightType = highlights.reduce((prev, curr) => {
          const severity = {error: 4, warning: 3, info: 2, success: 1};
          return severity[curr.type] > severity[prev.type] ? curr : prev;
        });

        highlightedContent += `<div class="${highlightType.type}-highlight">${escapeHtml(line)}</div>\n`;
      } else {
        highlightedContent += `${escapeHtml(line)}\n`;
      }
    });

    highlightDiv.innerHTML = highlightedContent;
  }

  function clearHighlights() {
    currentHighlights = [];
    updateCodeHighlight();
  }

  function highlightValidationErrors(validations) {
    clearHighlights();

    validations.forEach(validation => {
      if (validation.line > 0) {
        highlightLine(validation.line - 1, validation.type, 0, 1);
      }
    });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function validateWithAI() {
    const editor = document.getElementById('dockerfileEditor');
    const dockerfileContent = editor.value;

    if (!dockerfileContent.trim()) {
      showValidationResults([{
        type: 'error',
        message: 'Dockerfile tr·ªëng!',
        line: 0,
        suggestion: 'H√£y th√™m n·ªôi dung v√†o Dockerfile tr∆∞·ªõc khi ki·ªÉm tra.'
      }]);
      return;
    }

    // Show loading
    document.getElementById('aiThinking').classList.add('active');
    document.getElementById('validationStatus').className = 'validation-status status-warning';
    document.getElementById('validationStatus').textContent = 'ƒêang ph√¢n t√≠ch...';

    try {
      const validation = await callAIValidation(dockerfileContent);
      showValidationResults(validation);
      highlightValidationErrors(validation);

      // Update status
      const hasErrors = validation.some(v => v.type === 'error');
      const hasWarnings = validation.some(v => v.type === 'warning');

      if (hasErrors) {
        document.getElementById('validationStatus').className = 'validation-status status-error';
        document.getElementById('validationStatus').textContent = 'C√≥ l·ªói';
      } else if (hasWarnings) {
        document.getElementById('validationStatus').className = 'validation-status status-warning';
        document.getElementById('validationStatus').textContent = 'C√≥ c·∫£nh b√°o';
      } else {
        document.getElementById('validationStatus').className = 'validation-status status-success';
        document.getElementById('validationStatus').textContent = 'T·ªët';
      }

    } catch (error) {
      console.error('AI Validation error:', error);
      showValidationResults([{
        type: 'error',
        message: `L·ªói khi g·ªçi AI: ${error.message}`,
        line: 0,
        suggestion: 'Ki·ªÉm tra Ollama c√≥ ƒëang ch·∫°y kh√¥ng: `ollama serve`'
      }]);
      document.getElementById('validationStatus').className = 'validation-status status-error';
      document.getElementById('validationStatus').textContent = 'L·ªói k·∫øt n·ªëi';
    } finally {
      document.getElementById('aiThinking').classList.remove('active');
    }
  }

  async function callAIValidation(dockerfileContent) {
    try {
      const prompt = `B·∫°n l√† chuy√™n gia Docker v√† DevOps v·ªõi 10 nƒÉm kinh nghi·ªám.
      H√£y ph√¢n t√≠ch Dockerfile sau v√† ƒë∆∞a ra nh·∫≠n x√©t chi ti·∫øt v·ªÅ:
      1. C√∫ ph√°p c√≥ ƒë√∫ng kh√¥ng
      2. C√≥ tu√¢n theo best practices kh√¥ng
      3. C√≥ v·∫•n ƒë·ªÅ v·ªÅ b·∫£o m·∫≠t kh√¥ng
      4. C√≥ th·ªÉ t·ªëi ∆∞u g√¨ kh√¥ng
      5. C√≥ l·ªói ti·ªÅm ·∫©n kh√¥ng

      Dockerfile:
      """
      ${dockerfileContent}
      """

      Tr·∫£ v·ªÅ k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng JSON array ch√≠nh x√°c v·ªõi format:
      [
        {
          "type": "error|warning|info|success",
          "message": "M√¥ t·∫£ chi ti·∫øt v·∫•n ƒë·ªÅ",
          "line": s·ªë_d√≤ng (b·∫Øt ƒë·∫ßu t·ª´ 1, 0 n·∫øu kh√¥ng x√°c ƒë·ªãnh),
          "suggestion": "G·ª£i √Ω s·ª≠a ch·ªØa c·ª• th·ªÉ"
        }
      ]

      Ch·ªâ tr·∫£ v·ªÅ JSON, kh√¥ng th√™m b·∫•t k·ª≥ text n√†o kh√°c.`;

      const response = await fetch(CURRENT_API.url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: CURRENT_API.model,
          messages: [
            {
              role: 'user',
              content: prompt
            }
          ],
          stream: false,
          options: {
            temperature: 0.1,
            num_predict: 1000
          }
        })
      });

      if (!response.ok) {
        throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      const content = data.message.content;

      // Parse JSON t·ª´ response
      try {
        const parsed = JSON.parse(content);
        return Array.isArray(parsed) ? parsed : [{
          type: 'error',
          message: 'AI tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng kh√¥ng ƒë√∫ng',
          line: 0,
          suggestion: 'Th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra prompt'
        }];
      } catch (e) {
        console.error('Failed to parse AI response:', content);
        return extractValidationFromText(content);
      }

    } catch (error) {
      console.error('API call failed:', error);
      // Fallback to mock data if Ollama is not available
      return simulateAIValidation(dockerfileContent);
    }
  }

  function extractValidationFromText(text) {
    // Fallback: c·ªë g·∫Øng extract validation t·ª´ text response
    const validations = [];
    const lines = text.split('\n');
    let currentLine = 0;

    lines.forEach((line, index) => {
      const lineLower = line.toLowerCase();

      // Try to find line numbers in the text
      const lineMatch = line.match(/line\s+(\d+)/i) || line.match(/d√≤ng\s+(\d+)/i);
      if (lineMatch) {
        currentLine = parseInt(lineMatch[1]);
      }

      if (lineLower.includes('error') || lineLower.includes('l·ªói')) {
        validations.push({
          type: 'error',
          message: line,
          line: currentLine,
          suggestion: 'C·∫ßn ki·ªÉm tra l·∫°i c√∫ ph√°p ho·∫∑c logic'
        });
      } else if (lineLower.includes('warning') || lineLower.includes('c·∫£nh b√°o') || lineLower.includes('warning')) {
        validations.push({
          type: 'warning',
          message: line,
          line: currentLine,
          suggestion: 'N√™n c·∫£i thi·ªán ƒë·ªÉ t·ªët h∆°n'
        });
      } else if (lineLower.includes('suggestion') || lineLower.includes('g·ª£i √Ω') || lineLower.includes('n√™n') || lineLower.includes('recommend')) {
        validations.push({
          type: 'info',
          message: line,
          line: currentLine,
          suggestion: line
        });
      } else if (lineLower.includes('good') || lineLower.includes('t·ªët') || lineLower.includes('excellent') || lineLower.includes('tuy·ªát')) {
        validations.push({
          type: 'success',
          message: line,
          line: currentLine,
          suggestion: ''
        });
      }
    });

    return validations.length > 0 ? validations : [{
      type: 'info',
      message: 'AI ƒë√£ ph√¢n t√≠ch Dockerfile c·ªßa b·∫°n',
      line: 0,
      suggestion: text.substring(0, 200) + '...'
    }];
  }

  function simulateAIValidation(dockerfileContent) {
    // Mock AI validation cho demo khi Ollama kh√¥ng c√≥
    const lines = dockerfileContent.split('\n');
    const validations = [];

    // Check for common issues
    lines.forEach((line, index) => {
      const lineNum = index + 1;

      // Check for :latest tag
      if (line.includes('FROM') && line.includes(':latest')) {
        validations.push({
          type: 'warning',
          message: 'S·ª≠ d·ª•ng tag "latest" c√≥ th·ªÉ g√¢y ra v·∫•n ƒë·ªÅ version',
          line: lineNum,
          suggestion: 'Thay b·∫±ng version c·ª• th·ªÉ, v√≠ d·ª•: FROM eclipse-temurin:17-jdk-alpine'
        });
      }

      // Check for root user
      if (line.includes('USER') && line.includes('root')) {
        validations.push({
          type: 'error',
          message: 'Ch·∫°y container v·ªõi root user l√† nguy hi·ªÉm',
          line: lineNum,
          suggestion: 'T·∫°o non-root user: RUN adduser -D appuser && USER appuser'
        });
      }

      // Check for COPY . .
      if (line.trim() === 'COPY . .') {
        validations.push({
          type: 'warning',
          message: 'COPY . . c√≥ th·ªÉ copy c·∫£ file kh√¥ng c·∫ßn thi·∫øt',
          line: lineNum,
          suggestion: 'S·ª≠ d·ª•ng .dockerignore ho·∫∑c copy t·ª´ng file c·ª• th·ªÉ'
        });
      }

      // Check for EXPOSE kh√¥ng c√≥
      if (!dockerfileContent.includes('EXPOSE') && lineNum === lines.length) {
        validations.push({
          type: 'warning',
          message: 'Thi·∫øu l·ªánh EXPOSE cho port',
          line: lineNum,
          suggestion: 'Th√™m: EXPOSE 8080 (ho·∫∑c port c·ªßa ·ª©ng d·ª•ng)'
        });
      }

      // Check for HEALTHCHECK kh√¥ng c√≥
      if (!dockerfileContent.includes('HEALTHCHECK') && lineNum === lines.length) {
        validations.push({
          type: 'info',
          message: 'C√≥ th·ªÉ th√™m HEALTHCHECK ƒë·ªÉ monitoring',
          line: lineNum,
          suggestion: 'Th√™m: HEALTHCHECK CMD curl -f http://localhost:8080/actuator/health || exit 1'
        });
      }
    });

    // Check for multi-stage build
    const fromCount = (dockerfileContent.match(/FROM/g) || []).length;
    if (fromCount === 1) {
      validations.push({
        type: 'info',
        message: 'C√≥ th·ªÉ s·ª≠ d·ª•ng multi-stage build ƒë·ªÉ gi·∫£m k√≠ch th∆∞·ªõc image',
        line: 1,
        suggestion: 'Th√™m stage th·ª© hai v·ªõi JRE slim v√† COPY --from=builder'
      });
    }

    // Check for JVM options
    if (dockerfileContent.includes('ENTRYPOINT') && !dockerfileContent.includes('UseContainerSupport')) {
      validations.push({
        type: 'warning',
        message: 'Thi·∫øu JVM options t·ªëi ∆∞u cho container',
        line: lines.findIndex(l => l.includes('ENTRYPOINT')) + 1,
        suggestion: 'Th√™m: -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0'
      });
    }

    // If no issues found
    if (validations.length === 0) {
      validations.push({
        type: 'success',
        message: 'Dockerfile c·ªßa b·∫°n tr√¥ng t·ªët! ƒê√£ tu√¢n theo nhi·ªÅu best practices.',
        line: 0,
        suggestion: 'Ti·∫øp t·ª•c ph√°t tri·ªÉn v√† test k·ªπ v·ªõi c√°c m√¥i tr∆∞·ªùng kh√°c nhau.'
      });
    }

    return validations;
  }

  function showValidationResults(validations) {
    validationResults = validations;
    const validationList = document.getElementById('validationList');
    validationList.innerHTML = '';

    if (validations.length === 0) {
      validationList.innerHTML = `
        <div class="validation-item success">
          <div class="validation-message">
            ‚úÖ Dockerfile c·ªßa b·∫°n ho√†n h·∫£o! Kh√¥ng c√≥ v·∫•n ƒë·ªÅ n√†o ƒë∆∞·ª£c ph√°t hi·ªán.
          </div>
        </div>
      `;
      return;
    }

    validations.forEach((validation, index) => {
      const item = document.createElement('div');
      item.className = `validation-item ${validation.type}`;

      const lineInfo = validation.line > 0 ? `D√≤ng ${validation.line}` : '';

      item.innerHTML = `
        <div class="validation-item-header">
          <div class="validation-type">
            ${validation.type === 'error' ? '‚ùå L·ªói' :
        validation.type === 'warning' ? '‚ö†Ô∏è C·∫£nh b√°o' :
          validation.type === 'success' ? '‚úÖ Th√†nh c√¥ng' : '‚ÑπÔ∏è Th√¥ng tin'}
          </div>
          ${lineInfo ? `<div class="validation-line">${lineInfo}</div>` : ''}
        </div>
        <div class="validation-message">${validation.message}</div>
        ${validation.suggestion ? `
          <div class="validation-suggestion">
            <strong>G·ª£i √Ω:</strong> ${validation.suggestion}
          </div>
        ` : ''}
      `;

      // Add click handler to highlight line
      if (validation.line > 0) {
        item.addEventListener('click', () => {
          highlightValidationLine(validation.line - 1);
          // Scroll to line
          const editor = document.getElementById('dockerfileEditor');
          const lineHeight = 24;
          editor.scrollTop = (validation.line - 1) * lineHeight;
        });
      }

      validationList.appendChild(item);
    });
  }

  function highlightValidationLine(lineIndex) {
    clearHighlights();
    highlightLine(lineIndex, 'warning', 0, 1);

    // Auto-remove after 5 seconds
    setTimeout(() => {
      currentHighlights = currentHighlights.filter(h =>
        !(h.line === lineIndex && h.type === 'warning')
      );
      updateCodeHighlight();
    }, 5000);
  }

  async function applyAISuggestion(type) {
    const editor = document.getElementById('dockerfileEditor');
    const dockerfileContent = editor.value;

    // For demo purposes, use mock suggestions
    // In real implementation, you would call Ollama API
    let suggestion = '';

    switch(type) {
      case 'optimize':
        suggestion = `# T·ªëi ∆∞u h√≥a t·ª´ AI:
# 1. K·∫øt h·ª£p c√°c l·ªánh RUN ƒë·ªÉ gi·∫£m s·ªë layer
# 2. S·ª≠ d·ª•ng --no-cache cho apt-get update
# 3. X√≥a cache package manager sau khi c√†i ƒë·∫∑t
# 4. S·ª≠ d·ª•ng specific version tags thay v√¨ latest`;
        break;
      case 'security':
        suggestion = `# C·∫£i thi·ªán b·∫£o m·∫≠t t·ª´ AI:
# 1. Th√™m non-root user: RUN adduser -D appuser && USER appuser
# 2. Scan image v·ªõi trivy ho·∫∑c grype
# 3. S·ª≠ d·ª•ng trusted base images t·ª´ Docker Official
# 4. ƒê·∫∑t quy·ªÅn file ph√π h·ª£p: RUN chown -R appuser:appuser /app`;
        break;
      case 'performance':
        suggestion = `# T·ªëi ∆∞u hi·ªáu nƒÉng t·ª´ AI:
# 1. Th√™m JVM options: -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC
# 2. S·ª≠ d·ª•ng connection pooling cho database
# 3. Enable HTTP/2 n·∫øu d√πng web server
# 4. C·∫•u h√¨nh thread pool ph√π h·ª£p`;
        break;
      case 'multistage':
        suggestion = `# Multi-stage build g·ª£i √Ω:
FROM eclipse-temurin:17-jdk-alpine as builder
WORKDIR /app
COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src
RUN ./gradlew clean build -x test --no-daemon

FROM eclipse-temurin:17-jre-alpine
RUN adduser -D appuser
WORKDIR /app
COPY --from=builder --chown=appuser:appuser /app/build/libs/*.jar app.jar
USER appuser
EXPOSE 8080
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \\
  CMD curl -f http://localhost:8080/actuator/health || exit 1
ENTRYPOINT ["java", "-jar", "app.jar"]`;
        break;
    }

    if (suggestion) {
      // Insert suggestion at the end
      const newContent = dockerfileContent + '\n\n# AI Suggestion:\n' + suggestion;
      editor.value = newContent;

      // Validate after applying suggestion
      setTimeout(() => validateWithAI(), 1000);
    }
  }

  function copyDockerfile() {
    const editor = document.getElementById('dockerfileEditor');
    navigator.clipboard.writeText(editor.value).then(() => {
      const button = document.querySelector('.action-btn.copy');
      const originalText = button.innerHTML;
      button.innerHTML = '‚úì Copied!';
      setTimeout(() => button.innerHTML = originalText, 2000);
    });
  }

  function resetDockerfile() {
    if (confirm('Reset Dockerfile v·ªÅ m·∫∑c ƒë·ªãnh?')) {
      const editor = document.getElementById('dockerfileEditor');
      editor.value = `# Dockerfile Generated by Dockerfile Generator - Java/Spring
# Optimized for production

FROM eclipse-temurin:17-jdk-alpine as builder

WORKDIR /app

COPY . .

RUN ./gradlew clean build -x test

FROM eclipse-temurin:17-jre-alpine

WORKDIR /app

COPY --from=builder /app/build/libs/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]`;

      // Clear validation results v√† highlights
      document.getElementById('validationList').innerHTML = `
        <div class="validation-item info">
          <div class="validation-message">
            Dockerfile ƒë√£ ƒë∆∞·ª£c reset. Nh·∫•n "AI Validate" ƒë·ªÉ ki·ªÉm tra.
          </div>
        </div>
      `;
      document.getElementById('validationStatus').className = 'validation-status status-success';
      document.getElementById('validationStatus').textContent = 'Ch∆∞a ki·ªÉm tra';
      clearHighlights();
    }
  }

  // Initialize v·ªõi basic category visible
  document.querySelectorAll('.config-group').forEach(group => {
    if (group.id !== 'group-basic') {
      group.style.display = 'none';
    }
  });

  // H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Ollama
  console.log(`
  ============================================
  ƒê·ªÉ s·ª≠ d·ª•ng AI Validation v·ªõi Ollama:

  1. C√†i ƒë·∫∑t Ollama: https://ollama.com/
  2. Pull model: ollama pull phi3:mini
  3. Ch·∫°y Ollama server: ollama serve
  4. ƒê·∫£m b·∫£o Ollama ƒëang ch·∫°y ·ªü http://localhost:11434

  C√°c model kh√°c c√≥ th·ªÉ d√πng:
  - llama2, llama3
  - mistral
  - codellama (t·ªët cho code)
  - deepseek-coder

  Hi·ªán t·∫°i ƒëang d√πng phi3:mini (nh·∫π, nhanh)
  ============================================
  `);
</script>
</body>
</html>
